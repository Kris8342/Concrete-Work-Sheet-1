<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Concrete Job Form</title>
  <style>
    /* ===== SCREEN STYLES ===== */
    body{font-family:Arial,sans-serif;margin:20px;line-height:1.5;}
    .form-container{max-width:900px;margin:0 auto;padding:20px;
                    background:#f9f9f9;border:1px solid #ccc;border-radius:6px;}
    .header{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:0px;}
    .input-group{display:flex;align-items:center;gap:8px;font-size:15px;}
    label{font-weight:bold;}
    .input-field{border:none;border-bottom:1px solid #333;
                 padding:4px;width:200px;font-size:15px;}
    .section-title{font-size:18px;font-weight:bold;margin:20px 0 10px;
                   border-bottom:2px solid #333;padding-bottom:4px;}
    .subsection-title{font-size:16px;font-weight:bold;margin:15px 0 8px;}
    table{width:100%;border-collapse:collapse;margin-bottom:15px;font-size:14px;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top;}
    th{background:#f2f2f2;font-weight:bold;}
    .checkbox-group{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:14px;}
    .checkbox-item{display:flex;align-items:center;gap:5px;font-size:14px;}
    .section{background:#fff;border:1px solid #ddd;padding:15px;
             margin-bottom:20px;border-radius:5px;page-break-inside:avoid;}
    .remove-section{background:#f44336;color:#fff;border:none;border-radius:4px;
                     padding:5px 10px;cursor:pointer;float:right;}
    textarea{width:100%;height:80px;border:1px solid #ddd;padding:8px;resize:vertical;}
    .counter-group{display:flex;gap:6px;}
    .counter-group input{width:70px;}
    .btn{padding:8px 15px;border:none;border-radius:4px;
         color:#fff;font-size:14px;cursor:pointer;margin:10px 10px 0 0;}
    .btn-green{background:#4caf50;}
    .btn-blue {background:#2196f3;}
    .no-print{display:inline-block;}
    /* ===== PRINT STYLES (one-page) ===== */
    @media print {
      @page{size:letter portrait;margin:0.3in;}
      html,body{width:100%;height:100%;margin:0;padding:0;
                font-size:10px;line-height:1.2;zoom:0.75;}
      .no-print,.remove-section{display:none!important;}
      .form-container{border:none;padding:0;margin:0;}
      table{font-size:9px;margin-bottom:4px;}
      th,td{padding:3px;}
      label,th,td,input,select,textarea{font-size:9px!important;}
      .section-title{font-size:12px!important;margin:6px 0 4px!important;padding-bottom:2px!important;}
      .subsection-title{font-size:11px!important;margin:4px 0 2px!important;}
      .input-group,.checkbox-group,.section{margin-bottom:4px!important;padding:4px!important;}
      .counter-group input{width:40px!important;}
      textarea{height:50px!important;}
      .section{page-break-inside:avoid;}
      
      /* Optimized table layout */
      td input, td select, td textarea {
        width: 100% !important;
        padding: 2px !important;
      }

      .checkbox-item label {
        margin-left: 2px;
      }
    }
  </style>
</head>
<body>

  <div class="form-container" id="form-root">
    <!-- HEADER -->
    <div class="header">
      <div class="input-group">
        <label for="name">Name / Nombre:</label>
        <input id="name" class="input-field" type="text" placeholder="" />
      </div>
      <div class="input-group">
        <label for="date">Date Poured / Fecha Vaciado:</label>
        <input id="date" class="input-field" type="text" placeholder="" />
      </div>
      <div class="input-group" style="flex:1 1 100%;">
        <label for="address">Job Address / Dirección del Trabajo:</label>
        <input id="address" class="input-field" style="width:400px" type="text" placeholder="" />
      </div>
      <div class="input-group" style="flex:1 1 100%;">
        <label for="customer">Customer / Cliente:</label>
        <input id="customer" class="input-field" style="width:400px" type="text" placeholder="" />
      </div>
    </div>

    <!-- FOOTING SECTIONS -->
    <div id="sections-container">
      <div class="section" id="section-1">
        <button
          class="remove-section no-print"
          onclick="removeSection(this.parentNode)"
        >
          Remove
        </button>
        <div class="section-title">
          Footing Section / Sección de Cimentación 1
        </div>

        <!-- Length / Width / Depth -->
        <table>
          <tr>
            <th>Length (ft) / Largo (pies)</th>
            <th>Width (in) / Ancho (pulg)</th>
            <th>Depth (in) / Profundidad (pulg)</th>
          </tr>
          <tr>
            <td>
              <div class="counter-group">
                <input type="number" step="100" min="0" placeholder="" />
              </div>
            </td>
            <td><input type="number" step="6" min="0" placeholder="" /></td>
            <td><input type="number" step="6" min="0" placeholder="" /></td>
          </tr>
        </table>

        <!-- Uprights -->
        <table>
          <tr>
            <th colspan="2">Uprights / Verticales</th>
            <th>Length (ft) / Largo (pies)</th>
          </tr>
          <tr>
            <td style="width:120px;">Quantity / Cantidad</td>
            <td><input type="number" step="5" min="0" placeholder="" /></td>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
          </tr>
        </table>

        <!-- Crossbars -->
        <table>
          <tr>
            <th colspan="2">Crossbars / Travesaños</th>
            <th>Length (ft) / Largo (pies)</th>
          </tr>
          <tr>
            <td style="width:120px;">Quantity / Cantidad</td>
            <td><input type="number" step="5" min="0" placeholder="" /></td>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
          </tr>
        </table>

        <!-- Single / Double Mat -->
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input id="single-mat-1" type="checkbox" />
            <label for="single-mat-1">Single Mat / Malla Simple</label>
          </div>
          <div class="checkbox-item">
            <input id="double-mat-1" type="checkbox" />
            <label for="double-mat-1">Double Mat / Malla Doble</label>
          </div>
        </div>

        <!-- Rebar -->
        <table>
          <tr>
            <th>Rebar Qty / Cant. Varilla</th>
            <th>Size / Tamaño</th>
          </tr>
          <tr>
            <td>
              <div class="counter-group">
                <input type="number" step="10" min="0" placeholder="" />
              </div>
            </td>
            <td>
              <select>
                <option value="">Select Size</option>
                <option>#4</option>
                <option>#5</option>
                <option>#6</option>
                <option>#7</option>
                <option>#8</option>
                <option>#9</option>
                <option>#10</option>
              </select>
            </td>
          </tr>
        </table>

        <!-- Bulkheads -->
        <table>
          <tr>
            <th>Bulkheads / Mamparos</th>
            <th>Qty / Cantidad</th>
            <th>Height / Altura</th>
          </tr>
          <tr>
            <td></td>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
            <td><input type="number" step="0.01" min="0" placeholder="" /></td>
          </tr>
        </table>

        <!-- Piers -->
        <table>
          <tr>
            <th>Piers Qty / Cant. Pilares</th>
            <th>Size / Tamaño</th>
            <th>Custom / Pers.</th>
          </tr>
          <tr>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
            <td>
              <select
                id="piersize-1"
                onchange="toggleCustomSize(this)"
              >
                <option value="">Select Size</option>
                <option>2' x 2' x 12"</option>
                <option>3' x 3' x 12"</option>
              </select>
            </td>
            <td class="checkbox-item">
              <input
                type="checkbox"
                id="piercustom-1"
                onchange="enableCustomInput(this)"
              />
              <label for="piercustom-1">Custom Size / Tamaño Pers.</label>
              <input
                type="text"
                id="piercustominput-1"
                disabled
                style="width:120px"
                placeholder=""
              />
            </td>
          </tr>
        </table>

        <!-- Fireplace & Porch Pad -->
        <div class="subsection-title">Fireplace / Chimenea</div>
        <input type="text" style="width:100%;margin-bottom:10px" placeholder="" />
        <div class="subsection-title">Porch Pad / Base Porche</div>
        <input type="text" style="width:100%;margin-bottom:10px" placeholder="" />

        <!-- Additional Materials -->
        <div class="subsection-title">Additional Materials / Materiales Ad.</div>
        <table>
          <tr>
            <th>Item / Artículo</th>
            <th>Qty / Cantidad</th>
            <th>Notes / Notas</th>
          </tr>
          <tr>
            <td>
              <input type="text" placeholder="" />
            </td>
            <td><input type="number" step="2" min="0" placeholder="" /></td>
            <td><input type="text" placeholder="" /></td>
          </tr>
          <tr>
            <td><input type="text" placeholder="" /></td>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
            <td><input type="text" placeholder="" /></td>
          </tr>
          <tr>
            <td><input type="text" placeholder="" /></td>
            <td><input type="number" step="1" min="0" placeholder="" /></td>
            <td><input type="text" placeholder="" /></td>
          </tr>
        </table>

        <!-- Section Notes -->
        <div class="subsection-title">Section Notes / Notas Sección</div>
        <textarea placeholder=""></textarea>
      </div>
    </div>

    <!-- ADD / COUNT SECTIONS -->
    <button class="btn btn-blue no-print" onclick="addSection()">
      Add Section / Agregar Sección
    </button>
    <div class="section-title">
      Number of Sections / Número de Secciones:
    </div>
    <div class="checkbox-group" id="section-count-group">
      <!-- checkboxes generated by script -->
    </div>

    <!-- CONCRETE INFO -->
    <div class="section-title">Concrete Info / Info de Concreto</div>
    <div class="checkbox-group">
      <div class="checkbox-item">
        <input
          id="imi"
          name="concrete-company"
          type="checkbox"
          onclick="updateConcreteCompany('imi')"
        />
        <label for="imi">IMI</label>
      </div>
      <div class="checkbox-item">
        <input
          id="srm"
          name="concrete-company"
          type="checkbox"
          onclick="updateConcreteCompany('srm')"
        />
        <label for="srm">SRM</label>
      </div>
      <div class="input-group" style="flex:1;">
        <label for="other-company">Other / Otro:</label>
        <input
          id="other-company"
          class="input-field"
          type="text"
          oninput="updateConcreteCompany('other')"
          placeholder=""
        />
      </div>
    </div>
    <table>
      <tr>
        <th>Yards Poured / Yardas Vertidas</th>
      </tr>
      <tr>
        <td>
          <div class="counter-group">
            <input id="yards-tens" type="number" step="10" min="0" placeholder="" />
          </div>
        </td>
      </tr>
    </table>
    <table>
      <tr>
        <th>Additives / Aditivos</th>
        <th>Strength (psi) / Resistencia (psi)</th>
      </tr>
      <tr>
        <td>
          <input
            id="additives"
            class="input-field"
            type="text"
            style="width:100%"
            placeholder=""
          />
        </td>
        <td><input id="strength" type="number" step="500" min="3000" placeholder="" /></td>
      </tr>
    </table>

    <!-- PUMP CO. -->
    <div class="section-title">Pump Co. / Empresa Bomba</div>
    <div class="checkbox-group">
      <div class="checkbox-item">
        <input
          id="pump-cpp"
          name="pump-company"
          type="checkbox"
          onclick="updatePumpCompany('cpp')"
        />
        <label for="pump-cpp">CPP</label>
      </div>
      <div class="checkbox-item">
        <input
          id="pump-brundage"
          name="pump-company"
          type="checkbox"
          onclick="updatePumpCompany('brundage')"
        />
        <label for="pump-brundage">Brundage</label>
      </div>
      <div class="input-group" style="flex:1;">
        <label for="pump-other">Other / Otro:</label>
        <input
          id="pump-other"
          class="input-field"
          type="text"
          oninput="updatePumpCompany('other')"
          placeholder=""
        />
      </div>
    </div>

    <!-- CREW INFO -->
    <div class="section-title">Crew Info / Info del Equipo</div>
    <table id="crew-table">
      <tr>
        <th>Name / Nombre</th>
        <th>Role / Rol</th>
        <th>Hours / Horas</th>
      </tr>
      <tr>
        <td><input type="text" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
        <td><input type="number" step="0.5" placeholder="" /></td>
      </tr>
      <tr>
        <td><input type="text" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
        <td><input type="number" step="0.5" placeholder="" /></td>
      </tr>
      <tr>
        <td><input type="text" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
        <td><input type="number" step="0.5" placeholder="" /></td>
      </tr>
    </table>
    <button class="btn btn-blue no-print" onclick="addCrewMember()">
      Add Crew Member / Agregar Miembro
    </button>

    <!-- EQUIPMENT USED -->
    <div class="section-title">Equipment Used / Equipo Usado</div>
    <table id="equipment-table">
      <tr>
        <th>Equipment / Equipo</th>
        <th>Hours / Horas</th>
        <th>Notes / Notas</th>
      </tr>
      <tr>
        <td><input type="text" placeholder="" /></td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
      <tr>
        <td><input type="text" placeholder="" /></td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
    </table>
    <button class="btn btn-blue no-print" onclick="addEquipmentRow()">
      Add Equipment / Agregar Equipo
    </button>

    <!-- EQUIP HRS / DESC -->
    <div class="section-title">Equipment Hours & Description / Horas y Descripción</div>
    <table>
      <tr>
        <th>Equipment</th>
        <th>Hours</th>
        <th>Description</th>
      </tr>
      <tr>
        <td>MiniX</td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
      <tr>
        <td>Hammer</td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
      <tr>
        <td>Skid / Dingo</td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
      <tr>
        <td>Step Pad</td>
        <td><input type="number" step="0.5" placeholder="" /></td>
        <td><input type="text" placeholder="" /></td>
      </tr>
    </table>

    <!-- SUPPLIES USED -->
    <div class="section-title">Supplies Used / Suministros Usados</div>
    <table>
      <tr>
        <th>Supply / Suministro</th>
        <th>Quantity / Notas</th>
      </tr>
      <tr>
        <td>Paint / Pintura</td>
        <td>
          Boxes/Cajas <input type="number" style="width:60px" placeholder="" />
          Cans/Latas <input type="number" style="width:60px" placeholder="" />
        </td>
      </tr>
      <tr>
        <td>Chairs (boxes) / Sillas (cajas)</td>
        <td><input type="number" placeholder="" /></td>
      </tr>
      <tr>
        <td>Grade Pins (boxes) / Pines (cajas)</td>
        <td><input type="number" placeholder="" /></td>
      </tr>
      <tr>
        <td>2 × 4 × 16'</td>
        <td><input type="number" placeholder="" /></td>
      </tr>
      <tr>
        <td>Plywood (sheets) / Contrachapado</td>
        <td><input type="number" placeholder="" /></td>
      </tr>
      <tr>
        <td>Lumber Notes / Notas de Madera</td>
        <td><textarea id="lumber-notes" style="height:100px" placeholder=""></textarea></td>
      </tr>
    </table>

    <!-- MANAGEMENT JOB CODING -->
    <div class="section-title">Management Job Coding / Cod. Gestión</div>
    <div class="input-group">
      <label for="builder">Builder / Constructor:</label>
      <input id="builder" class="input-field" type="text" placeholder="" />
    </div>
    <div class="input-group">
      <label for="city-county">City/County / Ciudad:</label>
      <input id="city-county" class="input-field" type="text" placeholder="" />
    </div>
    <div class="checkbox-group">
      <div class="checkbox-item">
        <input id="job-turnkey" type="checkbox" />
        <label for="job-turnkey">Turnkey / Llave Mano</label>
      </div>
      <div class="checkbox-item">
        <input id="job-house" type="checkbox" />
        <label for="job-house">House / Casa</label>
      </div>
      <div class="checkbox-item">
        <input id="job-labor" type="checkbox" />
        <label for="job-labor">Labor Only / Solo O.</label>
      </div>
      <div class="checkbox-item">
        <input id="job-retaining" type="checkbox" />
        <label for="job-retaining">Retaining Wall / Muro</label>
      </div>
    </div>

    <!-- ADDITIONAL NOTES -->
    <div class="section-title">Additional Notes / Notas Adicionales</div>
    <textarea id="additional-notes" placeholder=""></textarea>

    <!-- SAVE AS PDF -->
    <button class="btn btn-green no-print" onclick="savePDF()">
      Save as PDF / Guardar PDF
    </button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // Set today's date
    document.getElementById('date').value = new Date().toLocaleDateString();

    // Enter key navigation (skip textarea)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        const fields = [
          ...document.querySelectorAll('input:not([type=checkbox]), select, textarea'),
        ].filter((el) => el.offsetParent);
        const idx = fields.indexOf(document.activeElement);
        (fields[idx + 1] || fields[0]).focus();
      }
    });

    // Fixed PDF saving function
    function savePDF() {
      // Hide non-printable elements
      const ui = document.querySelectorAll('.no-print');
      ui.forEach((el) => (el.style.display = 'none'));
      
      const element = document.getElementById('form-root');
      
      // Create a clone to preserve original styles
      const clone = element.cloneNode(true);
      clone.style.width = '100%';
      clone.style.overflow = 'visible';
      document.body.appendChild(clone);
      
      // Compress spacing for clone
      clone.querySelectorAll('*').forEach(el => {
        el.style.marginBottom = '2px';
        el.style.padding = '2px';
        el.style.lineHeight = '1.1';
        el.style.fontSize = '9px';
      });

      const opt = {
        margin: 0.2,
        filename: 'concrete_job_form.pdf',
        pagebreak: { mode: ['avoid-all', 'css'], before: '.section' },
        html2canvas: {
          scale: 1.5,
          useCORS: true,
          scrollY: 0,
          windowHeight: clone.scrollHeight
        },
        jsPDF: { 
          unit: 'in', 
          format: 'letter', 
          orientation: 'portrait',
          hotfixes: ['px_scaling']  // Fixes pixel scaling issues
        }
      };

      // Generate PDF
      html2pdf()
        .set(opt)
        .from(clone)
        .save()
        .then(() => {
          // Clean up and restore UI
          document.body.removeChild(clone);
          ui.forEach((el) => (el.style.display = ''));
        })
        .catch(err => {
          console.error('PDF generation failed:', err);
          document.body.removeChild(clone);
          ui.forEach((el) => (el.style.display = ''));
          alert('Failed to generate PDF. Please try again.');
        });
    }

    // Dynamic Sections
    let sectionCount = 1;
    function addSection() {
      sectionCount++;
      const t = document.getElementById('section-1').cloneNode(true);
      t.id = 'section-' + sectionCount;
      t.querySelectorAll('input,textarea').forEach((el) => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      ['single-mat-', 'double-mat-', 'piercustom-', 'piercustominput-', 'piersize-'].forEach(
        (pref) => {
          const el = t.querySelector('[id^="' + pref + '"]');
          if (el) {
            el.id = pref + sectionCount;
            const lbl = t.querySelector('label[for^="' + pref + '"]');
            if (lbl) lbl.htmlFor = el.id;
          }
        }
      );
      t.querySelector('.section-title').textContent =
        'Footing Section / Sección de Cimentación ' + sectionCount;
      document.getElementById('sections-container').appendChild(t);
    }
    function removeSection(sec) {
      const all = [...document.querySelectorAll('#sections-container .section')];
      if (all.length === 1) {
        alert('At least one section is required');
        return;
      }
      sec.remove();
      renumber();
    }
    function renumber() {
      sectionCount = 0;
      document.querySelectorAll('#sections-container .section').forEach((s, i) => {
        sectionCount = i + 1;
        s.id = 'section-' + sectionCount;
        s.querySelector('.section-title').textContent =
          'Footing Section / Sección de Cimentación ' + sectionCount;
      });
    }
    function updateSectionCount(n) {
      document.querySelectorAll('input[name="section-count"]').forEach((c) => (c.checked = false));
      document.getElementById('section-count-' + n).checked = true;
      while (sectionCount < n) addSection();
      while (sectionCount > n) {
        document.querySelector('#sections-container .section:last-child').remove();
        sectionCount--;
      }
    }

    // Custom pier size
    function enableCustomInput(cb) {
      const i = cb.id.split('-')[1];
      const inp = document.getElementById('piercustominput-' + i);
      inp.disabled = !cb.checked;
      if (!cb.checked) inp.value = '';
    }
    function toggleCustomSize(sel) {
      const i = sel.id.split('-')[1];
      const cb = document.getElementById('piercustom-' + i);
      const inp = document.getElementById('piercustominput-' + i);
      cb.checked = false;
      inp.disabled = true;
      inp.value = '';
    }

    // Crew & Equipment rows
    function addCrewMember() {
      const r = document.getElementById('crew-table').insertRow(-1);
      r.innerHTML =
        '<td><input type="text" placeholder=""></td><td><input type="text" placeholder=""></td><td><input type="number" step="0.5" placeholder=""></td>';
    }
    function addEquipmentRow() {
      const r = document.getElementById('equipment-table').insertRow(-1);
      r.innerHTML =
        '<td><input type="text" placeholder=""></td><td><input type="number" step="0.5" placeholder=""></td><td><input type="text" placeholder=""></td>';
    }

    // Single-select helpers
    function updateConcreteCompany(c) {
      document.querySelectorAll('input[name="concrete-company"]').forEach((b) => (b.checked = false));
      if (c === 'imi' || c === 'srm') {
        document.getElementById(c).checked = true;
        document.getElementById('other-company').value = '';
      }
    }
    function updatePumpCompany(c) {
      document.querySelectorAll('input[name="pump-company"]').forEach((b) => (b.checked = false));
      if (c === 'cpp' || c === 'brundage') {
        document.getElementById('pump-' + c).checked = true;
        document.getElementById('pump-other').value = '';
      }
    }
  </script>
</body>
</html>
